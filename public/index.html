<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>OBS Audio Source</title>
    <style>body { background-color: transparent; }</style>
</head>
<body>
    <script>
        const synth = window.speechSynthesis;
        let voices = [];
        
        // Эта часть работает отлично, не трогаем
        function populateVoiceList() {
            voices = synth.getVoices();
            if (voices.length > 0) {
                console.log('OBS Source: Голоса загружены. Найдено:', voices.length);
                if(voiceCheckInterval) clearInterval(voiceCheckInterval);
            }
        }
        populateVoiceList();
        const voiceCheckInterval = setInterval(() => { if (voices.length === 0) populateVoiceList(); else clearInterval(voiceCheckInterval); }, 250);
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = populateVoiceList;
        }

        // --- ИСПРАВЛЕННАЯ ЛОГИКА ПОДКЛЮЧЕНИЯ WEBSOCKET ---
        // Было: const socketUrl = location.protocol === 'https:' ? 'wss://' : 'ws://' + location.host; -> ОШИБКА
        // Стало:
        const socketUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host;
        
        let ws;
        function connect() {
            console.log('OBS Source: Попытка подключения к:', socketUrl);
            ws = new WebSocket(socketUrl);
            ws.onopen = () => console.log('OBS Source: Connected to server.');
            ws.onclose = () => setTimeout(connect, 3000);
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log("OBS Source: Получено сообщение от сервера:", data);
                if (data.type === 'play') {
                    speak(data.text, data.voiceName);
                }
            };
            ws.onerror = (err) => {
                console.error('OBS Source WebSocket Error:', err);
                ws.close();
            };
        }
        connect();
        
        // Функция озвучки (работает отлично, не трогаем)
        function speak(text, requestedVoiceName) {
            if (synth.speaking) {
                console.warn('OBS Source: Синтезатор уже говорит. Новая фраза отменена.');
                return;
            }
            if (text) {
                const utterThis = new SpeechSynthesisUtterance(text);
                let chosenVoice = voices.find(voice => voice.name === requestedVoiceName);
                if (!chosenVoice) {
                    console.warn(`OBS Source: Голос "${requestedVoiceName}" не найден. Ищем любой русский голос.`);
                    chosenVoice = voices.find(voice => voice.lang.includes('ru'));
                }
                if (!chosenVoice) {
                    console.error("OBS Source: Не найдено русских голосов. Будет использован голос по умолчанию.");
                }
                utterThis.voice = chosenVoice;
                console.log('OBS Source: Воспроизведение голосом:', chosenVoice ? chosenVoice.name : 'Default');
                synth.speak(utterThis);
            }
        }
    </script>
</body>
</html>