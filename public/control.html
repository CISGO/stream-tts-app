<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS Control</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        h1 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:disabled {
            background-color: #a0cffc;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        #status {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #606770;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Панель управления Text-to-Speech</h1>
        <textarea id="text-to-speak" placeholder="Введите текст для озвучивания..."></textarea>
        <button id="speak-button" disabled>Отправить</button>
        <div id="status">Подключение к серверу...</div>
    </div>

    <script>
        // Получаем доступ к элементам на странице
        const statusDiv = document.getElementById('status');
        const speakButton = document.getElementById('speak-button');
        const textInput = document.getElementById('text-to-speak');

        // Объявляем переменную для WebSocket
        let ws;

        // --- ГЛАВНАЯ ФУНКЦИЯ ПОДКЛЮЧЕНИЯ ---
        function connect() {
            // --- ЭТО ИЗМЕНЕННЫЙ БЛОК КОДА ---
            // Он динамически создает правильный URL для WebSocket

            // 1. Определяем протокол (wss:// для https://, ws:// для http://)
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';

            // 2. Получаем хост (домен) из адресной строки браузера.
            //    На вашем сайте это будет "stream-tts-app.onrender.com"
            const host = window.location.host;

            // 3. Укажите путь, на котором ваш сервер слушает WebSocket-соединения.
            //    Это самый важный параметр для проверки!
            //    Если ваш серверный код ожидает подключения по адресу /ws или /socket,
            //    измените значение ниже.
            const path = '/'; // <--- ПРОВЕРЬТЕ ЭТОТ ПУТЬ В КОНФИГУРАЦИИ ВАШЕГО СЕРВЕРА!

            // 4. Собираем полный URL
            const ws_url = protocol + host + path;

            // Выводим в консоль для отладки
            console.log("Попытка подключения к WebSocket по адресу:", ws_url);
            statusDiv.textContent = `Подключение к ${ws_url}...`;
            
            // --- КОНЕЦ ИЗМЕНЕННОГО БЛОКА ---

            // Создаем новый объект WebSocket
            ws = new WebSocket(ws_url);

            // Обработчик события: соединение успешно установлено
            ws.onopen = function(event) {
                console.log("Соединение WebSocket установлено.");
                statusDiv.textContent = "Соединение установлено. Готов к работе.";
                speakButton.disabled = false; // Делаем кнопку активной
            };

            // Обработчик события: получено сообщение от сервера
            ws.onmessage = function(event) {
                console.log("Получено сообщение от сервера:", event.data);
                // Здесь вы можете обрабатывать сообщения от сервера (например, статус задачи)
                statusDiv.textContent = `Ответ сервера: ${event.data}`;
            };

            // Обработчик события: соединение закрыто
            ws.onclose = function(event) {
                console.log("Соединение WebSocket закрыто. Код:", event.code, "Причина:", event.reason);
                statusDiv.textContent = "Соединение потеряно. Попытка переподключения через 5 секунд...";
                speakButton.disabled = true; // Делаем кнопку неактивной
                // Попытка переподключения через 5 секунд
                setTimeout(connect, 5000);
            };

            // Обработчик события: произошла ошибка
            ws.onerror = function(error) {
                console.error("Ошибка WebSocket:", error);
                statusDiv.textContent = "Произошла ошибка соединения.";
                speakButton.disabled = true;
            };
        }

        // Обработчик клика по кнопке
        speakButton.addEventListener('click', function() {
            const text = textInput.value;
            if (text && ws && ws.readyState === WebSocket.OPEN) {
                console.log("Отправка текста на сервер:", text);
                ws.send(text);
                statusDiv.textContent = "Текст отправлен на обработку...";
            } else {
                console.log("Не удалось отправить. Текст пустой или нет соединения.");
                statusDiv.textContent = "Ошибка: введите текст или проверьте соединение.";
            }
        });

        // --- ЗАПУСК ---
        // Вызываем функцию connect() при загрузке страницы, чтобы установить соединение
        connect();

    </script>
</body>
</html>